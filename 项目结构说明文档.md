# 项目结构说明文档

## 项目概述

本项目是一个基于 FastAPI 开发的综合管理系统，采用分层架构设计，包含财务管理系统、用户中心、订单系统和商品管理四大核心模块。项目使用 PyMySQL 作为数据库操作层，完全移除了 SQLAlchemy ORM，采用纯 SQL 方式进行数据库交互。

## 技术栈

- **Web 框架**: FastAPI 0.123.9+
- **数据库**: MySQL (通过 PyMySQL 1.1.2+ 连接)
- **数据验证**: Pydantic 2.12.5+
- **认证**: PyJWT 2.9.0+ (JWT Token)
- **密码加密**: bcrypt 4.2.0+
- **HTTP 客户端**: requests 2.32.0+
- **配置管理**: python-dotenv 1.2.1+
- **ASGI 服务器**: uvicorn 0.38.0+

## 项目目录结构

```
DS/
├── api/                    # API 路由层
├── assets/                 # 静态资源文件
├── core/                   # 核心基础模块
├── logs/                   # 日志文件目录
├── models/                 # 数据模型层
├── services/               # 业务逻辑层
├── database_setup.py       # 数据库初始化脚本
├── main.py                 # 应用入口文件
├── pyproject.toml          # 项目依赖配置
├── README.md               # 项目说明文档
└── uv.lock                 # 依赖锁定文件
```

---

## 详细目录说明

### 📁 api/ - API 路由层

API 路由层负责定义所有的 HTTP 接口端点，处理请求参数验证、调用服务层方法并返回响应。

#### 📁 api/finance/ - 财务系统 API

- **routes.py**: 财务系统相关的所有 API 路由
  - 数据库初始化接口 (`/api/init`, `/api/init-data`)
  - 用户管理接口 (`/api/users/*`)
  - 商品管理接口 (`/api/products/*`)
  - 订单结算接口 (`/api/orders/*`)
  - 优惠券接口 (`/api/coupons/*`)
  - 补贴发放接口 (`/api/subsidy/*`)
  - 提现接口 (`/api/withdrawals/*`)
  - 奖励审核接口 (`/api/rewards/*`)
  - 公益基金接口 (`/api/public-welfare/*`)
  - 财务报表接口 (`/api/reports/*`, `/api/admin/reports/*`)
  - 共包含 56+ 个财务相关接口

#### 📁 api/user/ - 用户中心 API

- **routes.py**: 用户中心相关的所有 API 路由
  - 用户认证接口 (`/user/auth`, `/user/wechat-login`)
  - 用户状态管理 (`/user/set-status`, `/user/freeze`, `/user/unfreeze`)
  - 用户资料管理 (`/user/info`, `/user/update-profile`)
  - 密码管理 (`/user/reset-password`, `/admin/user/reset-pwd`)
  - 用户等级管理 (`/user/upgrade`, `/user/set-level`)
  - 推荐关系管理 (`/user/bind-referrer`, `/user/refer-direct`)
  - 地址管理 (`/user/address/*`)
  - 积分管理 (`/user/points/*`)
  - 团队奖励 (`/user/reward/*`)
  - 董事功能 (`/user/director/*`)

#### 📁 api/order/ - 订单系统 API

- **__init__.py**: 订单模块路由注册入口，统一注册所有订单相关路由
- **cart.py**: 购物车相关接口
  - 添加商品到购物车
  - 查询购物车
  - 更新购物车商品数量
  - 删除购物车商品
- **order.py**: 订单管理接口
  - 创建订单
  - 查询订单列表
  - 查询订单详情
  - 订单状态更新
- **refund.py**: 退款相关接口
  - 申请退款
  - 查询退款记录
  - 退款审核
- **address.py**: 订单地址管理接口
  - 添加收货地址
  - 更新收货地址
  - 删除收货地址
  - 查询地址列表
- **merchant.py**: 商家后台接口
  - 商家订单查询
  - 商家数据统计
- **fasteners.py**: 紧固件相关接口（特殊业务模块）

#### 📁 api/product/ - 商品管理 API

- **routes.py**: 商品管理相关的所有 API 路由
  - 商品搜索 (`/product/search`)
  - 商品列表 (`/product/list`)
  - 商品详情 (`/product/{id}`)
  - 商品创建 (`/product/create`)
  - 商品更新 (`/product/update`)
  - 商品图片上传 (`/product/upload-image`)
  - 轮播图管理 (`/product/banner/*`)
  - 销售数据统计 (`/product/sales/*`)
- **ext.py**: 商品扩展功能接口

---

### 📁 core/ - 核心基础模块

核心模块提供项目的基础设施和通用功能，所有其他模块都依赖这些核心组件。

#### **config.py** - 统一配置管理

- **数据库配置**: `get_db_config()` - 从环境变量读取 MySQL 配置
- **平台常量**: 
  - `PLATFORM_MERCHANT_ID`: 平台商家 ID (0)
  - `MEMBER_PRODUCT_PRICE`: 会员商品价格 (1980.00)
- **业务规则枚举**: 
  - `AllocationKey`: 资金分配类型枚举（公益基金、平台、补贴池等）
  - `UserStatus`: 用户状态枚举
- **资金分配比例**: `ALLOCATIONS` - 定义订单金额的分配比例
- **业务规则常量**: 
  - `TAX_RATE`: 提现税率 (0.06)
  - `POINTS_DISCOUNT_RATE`: 积分抵扣比例 (0.5)
  - `MAX_POINTS_VALUE`: 最大积分价值
  - `COUPON_VALID_DAYS`: 优惠券有效期
  - `MAX_PURCHASE_PER_DAY`: 每日最大购买次数
  - `MAX_TEAM_LAYER`: 最大团队层级
- **微信配置**: `WECHAT_APP_ID`, `WECHAT_APP_SECRET` - 微信小程序配置
- **日志配置**: `LOG_FILE` - 日志文件路径

#### **database.py** - 数据库连接管理

- **get_conn()**: 数据库连接上下文管理器（统一入口）
  - 使用 PyMySQL 建立连接
  - 自动管理事务（失败时回滚）
  - 使用 DictCursor 返回字典格式结果
  - 连接自动关闭
- **get_db_config_cached()**: 获取缓存的数据库配置（避免重复读取环境变量）

#### **db_adapter.py** - 数据库适配器

- **PyMySQLAdapter**: 数据库会话适配器类
  - 封装 PyMySQL 连接操作
  - 提供 `execute()` 方法执行 SQL
  - 提供 `begin()`, `commit()`, `rollback()` 事务管理
  - 提供 `fetchone()`, `fetchall()` 结果获取方法
  - 支持上下文管理器模式

#### **middleware.py** - 中间件配置

- **setup_cors()**: 配置 CORS 跨域中间件
  - 允许所有来源 (`allow_origins=["*"]`)
  - 允许所有方法和请求头
- **setup_static_files()**: 配置静态文件服务
  - 仅在 `static/` 目录存在时挂载
  - 挂载路径: `/static`

#### **exceptions.py** - 统一异常定义

- **FinanceException**: 财务系统基础异常类
- **OrderException**: 订单相关异常（继承自 FinanceException）
- **InsufficientBalanceException**: 余额不足异常
  - 包含账户类型、需要金额、当前余额信息

---

### 📁 services/ - 业务逻辑层

服务层包含所有核心业务逻辑，负责处理复杂的业务规则和数据操作。

#### **finance_service.py** - 财务服务（核心业务逻辑）

财务系统的核心服务类，包含所有财务相关的业务逻辑：

- **订单结算** (`settle_order`): 
  - 处理会员订单和普通订单
  - 积分抵扣计算
  - 资金分配到各个账户池
  - 积分奖励计算
  - 推荐奖励和团队奖励处理
- **订单退款** (`refund_order`): 
  - 退款金额计算
  - 资金回退
  - 积分回退
- **补贴发放** (`distribute_weekly_subsidy`): 
  - 周补贴自动发放
  - 积分转优惠券
  - 补贴池资金管理
- **提现管理** (`apply_withdrawal`, `audit_withdrawal`): 
  - 提现申请处理
  - 税费计算
  - 提现审核流程
- **奖励管理** (`audit_rewards`): 
  - 批量审核奖励
  - 奖励转优惠券
- **账户余额查询** (`get_account_balance`, `get_user_balance`): 
  - 查询各类账户余额
  - 用户余额查询
- **流水查询** (`get_account_flow`, `get_points_log`): 
  - 资金流水记录
  - 积分流水记录
- **报表生成** (`get_finance_report`, `get_points_deduction_report`): 
  - 财务报表生成
  - 积分抵扣明细报表

#### **user_service.py** - 用户服务

用户相关的业务逻辑：

- **用户认证**: 登录、注册、密码验证
- **用户资料管理**: 更新昵称、头像、密码
- **用户状态管理**: 冻结、解冻、注销
- **密码加密**: `hash_pwd()` - 使用 bcrypt 加密密码
- **推荐码生成**: `_generate_code()` - 生成唯一推荐码
- **用户等级管理**: 升级、降级

#### **wechat_service.py** - 微信登录服务

微信小程序登录相关功能：

- **获取 OpenID** (`get_openid_by_code`): 通过微信 code 换取 openid 和 session_key
- **用户注册** (`register_user`): 为微信用户自动创建账号
- **用户查询** (`check_user_by_openid`): 通过 openid 查询用户
- **Token 生成** (`generate_token`): 生成 JWT token 用于用户认证
- **字段兼容** (`ensure_openid_column`): 确保 users 表存在 openid 字段

#### **address_service.py** - 地址服务

用户收货地址管理：

- 添加地址
- 更新地址
- 删除地址
- 查询地址列表
- 设置默认地址

#### **points_service.py** - 积分服务

用户积分相关功能：

- 积分增加/扣除
- 积分流水记录
- 积分查询
- 积分类型管理（用户积分、商家积分、公司积分）

#### **reward_service.py** - 奖励服务

用户奖励相关功能：

- 推荐奖励计算
- 团队奖励计算
- 奖励审核
- 奖励转优惠券

#### **director_service.py** - 董事服务

董事功能相关业务逻辑：

- 董事资格管理
- 董事奖励计算
- 董事数据统计

---

### 📁 models/ - 数据模型层

数据模型层定义所有的 Pydantic Schema，用于 API 请求和响应的数据验证。

#### 📁 models/schemas/ - 数据模式定义

- **finance.py**: 财务系统相关的数据模型
  - 订单结算请求/响应模型
  - 退款请求/响应模型
  - 提现请求/响应模型
  - 财务报表响应模型
  - 账户流水模型

- **user.py**: 用户中心相关的数据模型
  - 用户认证请求/响应模型
  - 用户信息模型
  - 用户状态更新模型
  - 地址模型
  - 积分模型

- **order.py**: 订单系统相关的数据模型
  - 订单创建请求/响应模型
  - 订单详情模型
  - 购物车模型
  - 退款模型

- **product.py**: 商品管理相关的数据模型
  - 商品信息模型
  - 商品创建/更新请求模型
  - 商品搜索请求模型
  - 商品列表响应模型

---

### 📁 assets/ - 静态资源文件

存放项目使用的静态资源文件，如图片、文档等。

---

### 📁 logs/ - 日志文件目录

存放应用运行时的日志文件，默认日志文件为 `logs/api.log`。

---

## 根目录文件说明

### **main.py** - 应用入口文件

FastAPI 应用的统一入口，负责：

- **创建 FastAPI 实例**: 配置应用元数据、文档地址
- **OpenAPI 配置**: 自定义 OpenAPI Schema，定义 API 标签
- **中间件配置**: 注册 CORS 和静态文件中间件
- **路由注册**: 注册所有模块的路由
  - `register_finance_routes()` - 财务系统路由
  - `register_user_routes()` - 用户中心路由
  - `register_order_routes()` - 订单系统路由
  - `register_product_routes()` - 商品管理路由
- **数据库初始化**: `ensure_database()` - 确保数据库存在
- **启动服务器**: 使用 uvicorn 启动 ASGI 服务器，支持热重载

### **database_setup.py** - 数据库初始化脚本

数据库表结构定义和初始化脚本：

- **DatabaseManager 类**: 
  - `_ensure_database_exists()`: 确保数据库存在，不存在则创建
  - `init_all_tables()`: 初始化所有数据表结构
  - `add_foreign_keys()`: 添加外键约束
  - `create_test_data()`: 创建测试数据
- **initialize_database()**: 数据库初始化主函数
  - 创建数据库
  - 创建所有表
  - 添加外键
  - 创建测试数据（可选）
- **表结构**: 定义了完整的数据库表结构，包括：
  - `users` - 用户表
  - `products` - 商品表
  - `orders` - 订单表
  - `finance_accounts` - 财务账户表
  - `account_flow` - 资金流水表
  - `points_log` - 积分流水表
  - `coupons` - 优惠券表
  - `withdrawals` - 提现记录表
  - `pending_rewards` - 待审核奖励表
  - `team_rewards` - 团队奖励表
  - `weekly_subsidy_records` - 周补贴记录表
  - 等等...

### **pyproject.toml** - 项目依赖配置

Python 项目配置文件，定义：

- 项目元数据（名称、版本、描述）
- Python 版本要求 (>=3.13)
- 项目依赖列表
- 项目 README 文件

### **README.md** - 项目说明文档

项目的基本使用说明，包括：

- 安装依赖
- 启动应用
- API 文档访问地址
- 环境变量配置示例

### **uv.lock** - 依赖锁定文件

由 `uv` 包管理器生成的依赖锁定文件，确保依赖版本的一致性。

### **.gitignore** - Git 忽略文件

定义 Git 版本控制中需要忽略的文件和目录，包括：

- Python 缓存文件 (`__pycache__/`, `*.pyc`)
- IDE 配置文件 (`.vscode/`)
- 构建产物 (`build/`, `dist/`)
- 虚拟环境 (`.venv`)
- 环境变量文件 (`.env`)
- 日志文件 (`*.log`)

---

## 架构设计说明

### 分层架构

项目采用经典的分层架构设计：

```
┌─────────────────────────────────────┐
│         API Layer (api/)            │  ← HTTP 请求处理、参数验证
├─────────────────────────────────────┤
│      Service Layer (services/)     │  ← 业务逻辑处理
├─────────────────────────────────────┤
│      Model Layer (models/)          │  ← 数据模型定义
├─────────────────────────────────────┤
│      Core Layer (core/)             │  ← 基础设施（数据库、配置、中间件）
└─────────────────────────────────────┘
```

### 数据流向

1. **请求流程**: 
   ```
   HTTP Request → API Route → Service → Database → Response
   ```

2. **数据库操作**: 
   ```
   Service → core.database.get_conn() → PyMySQL → MySQL Database
   ```

3. **配置管理**: 
   ```
   Application → core.config → Environment Variables (.env)
   ```

### 模块划分

- **财务系统**: `api/finance/` + `services/finance_service.py`
- **用户中心**: `api/user/` + `services/user_service.py` + `services/wechat_service.py`
- **订单系统**: `api/order/` + `services/address_service.py`
- **商品管理**: `api/product/` + 相关服务

---

## 环境变量配置

项目通过 `.env` 文件管理配置，需要配置以下环境变量：

```env
# 数据库配置
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=finan_manage_db

# 微信小程序配置（可选）
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret
```

---

## 启动说明

1. **安装依赖**:
   ```bash
   pip install -r requirements.txt
   # 或使用 uv
   uv pip install -r requirements.txt
   ```

2. **配置环境变量**: 创建 `.env` 文件并配置数据库连接信息

3. **启动应用**:
   ```bash
   python main.py
   ```

4. **访问 API 文档**:
   - Swagger UI: http://127.0.0.1:8000/docs
   - ReDoc: http://127.0.0.1:8000/redoc

---

## 注意事项

1. **数据库初始化**: 首次运行时会自动创建数据库和表结构
2. **日志文件**: 日志默认输出到 `logs/api.log`
3. **静态文件**: 如果存在 `static/` 目录，会自动挂载到 `/static` 路径
4. **事务管理**: 所有数据库操作都通过上下文管理器自动管理事务
5. **密码加密**: 用户密码使用 bcrypt 进行加密存储
6. **JWT Token**: 微信登录使用 JWT Token 进行用户认证

---

## 更新日志

- **移除 SQLAlchemy**: 项目已完全移除 SQLAlchemy ORM，使用纯 PyMySQL
- **分层架构重构**: 项目已重构为清晰的分层架构
- **统一配置管理**: 所有配置统一在 `core/config.py` 管理
- **统一数据库连接**: 所有数据库操作通过 `core/database.get_conn()` 统一管理

---

*最后更新: 2025-01-XX*
